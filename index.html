<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Delaware City Schools — Live Snow Status (Dec 2)</title>
  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444; --muted:#94a3b8;
      color-scheme: dark;
    }
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial; margin:0; background:linear-gradient(180deg,#071024 0%, #07142a 100%); color:#e6eef8;}
    .wrap{max-width:820px;margin:26px auto;padding:20px;}
    header{display:flex;align-items:center;gap:16px}
    h1{font-size:20px;margin:0}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px;padding:18px;margin-top:16px; box-shadow: 0 6px 30px rgba(2,6,23,0.6);}
    .status{display:flex;align-items:center;gap:14px}
    .big{font-weight:700;font-size:36px;letter-spacing:0.6px;}
    .pill{padding:8px 12px;border-radius:999px;font-weight:700;}
    .ok{background:rgba(22,163,74,0.12);color:var(--ok);border:1px solid rgba(22,163,74,0.12)}
    .warn{background:rgba(245,158,11,0.08);color:var(--warn);border:1px solid rgba(245,158,11,0.06)}
    .bad{background:rgba(239,68,68,0.08);color:var(--bad);border:1px solid rgba(239,68,68,0.06)}
    .muted{color:var(--muted);font-size:13px}
    ul{padding-left:18px;margin:8px 0 0 0}
    li.source{margin:10px 0;padding:10px;border-radius:8px;background:rgba(255,255,255,0.01);display:flex;justify-content:space-between;align-items:center}
    .srcName{font-weight:700}
    .srcText{font-size:14px;color:#d6e6ff}
    .time{font-size:12px;color:var(--muted)}
    .small{font-size:13px;color:var(--muted)}
    footer{margin-top:18px;font-size:13px;color:var(--muted)}
    .dot{width:10px;height:10px;border-radius:999px;display:inline-block}
    .controls{display:flex;gap:8px;align-items:center;margin-top:10px}
    button{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px 10px;border-radius:8px;color:inherit;cursor:pointer}
    .note{margin-top:12px;color:var(--muted);font-size:13px}
    @media(max-width:600px){.big{font-size:28px}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Delaware City Schools — Live Snow Status</h1>
        <div class="small">Auto-updates every 30s — target date: <strong>Tue, Dec 2</strong></div>
      </div>
    </header>

    <div class="card" id="mainCard">
      <div class="status">
        <div>
          <div class="big" id="combinedStatus">Checking…</div>
          <div class="muted" id="lastChecked">Last checked: —</div>
        </div>
        <div style="margin-left:auto;text-align:right">
          <div style="margin-bottom:6px"><span id="statusPill" class="pill muted">—</span></div>
          <div class="small">Sources: District + 10TV + NBC4 + ABC6</div>
        </div>
      </div>

      <ul id="sourcesList" style="margin-top:16px">
        <!-- JS will populate -->
      </ul>

      <div class="controls">
        <button id="refreshBtn">Refresh now</button>
        <div class="small" id="countdown">Next check in 30s</div>
      </div>

      <div class="note">
        How this works: the page fetches the district status page and the "closings" pages from three local news sites and searches for keywords (closed / cancel / delay / 2 hour delay). See disclaimers below.
      </div>

      <footer>
        <div class="small">Sources polled (live): Delaware City Schools, 10TV (WBNS), NBC4 (WCMH), ABC6 (WSYX). Data parsed from each site’s public pages. See source details below.</div>
      </footer>
    </div>

    <div class="card">
      <div class="muted">Source details and last raw result (for debugging):</div>
      <pre id="debug" style="white-space:pre-wrap;margin-top:8px;color:#bcd4ff;background:rgba(255,255,255,0.01);padding:10px;border-radius:8px;max-height:260px;overflow:auto"></pre>
    </div>
  </div>

  <script>
    // CONFIG: target URLs (official pages discovered)
    const TARGETS = [
      { id:'district', name:'Delaware City Schools (official)', url:'https://www.dcs.k12.oh.us/for-families/school-hours-delay-schedule/school-delay-closings' , hint: 'dcs.k12.oh.us' },
      { id:'10tv', name:'10TV (WBNS) - Closings', url:'https://www.10tv.com/closings' , hint: '10tv.com' },
      { id:'nbc4', name:'NBC4 (WCMH) - Closings', url:'https://www.firstalert4.com/weather/closings/' , hint: 'firstalert4.com (NBC4)' },
      { id:'abc6', name:'ABC6 (WSYX) - Closings', url:'https://abc6onyourside.com/weather/closings' , hint: 'abc6onyourside.com' }
    ];

    // CORS proxy - used so GitHub Pages can fetch external pages.
    // If the proxy fails, you can change to another public proxy or run your own.
    const CORS_PROXY = 'https://api.allorigins.win/raw?url='; // public proxy that returns raw content

    // polling
    const POLL_SECONDS = 30;
    let countdown = POLL_SECONDS;
    let timerId = null;

    const statusEl = document.getElementById('combinedStatus');
    const pill = document.getElementById('statusPill');
    const lastCheckedEl = document.getElementById('lastChecked');
    const sourcesList = document.getElementById('sourcesList');
    const debug = document.getElementById('debug');
    const countdownEl = document.getElementById('countdown');
    const refreshBtn = document.getElementById('refreshBtn');

    refreshBtn.onclick = () => { doCheck(); resetTimer(); };

    function humanTime(d = new Date()) {
      return d.toLocaleString(undefined, {hour:'numeric', minute:'2-digit', second:'2-digit', month:'short', day:'numeric', year:'numeric'});
    }

    function resetTimer(){
      countdown = POLL_SECONDS;
      if(timerId) clearInterval(timerId);
      timerId = setInterval(()=>{
        countdown--;
        countdownEl.textContent = `Next check in ${countdown}s`;
        if(countdown<=0){ doCheck(); countdown = POLL_SECONDS; }
      },1000);
    }

    async function fetchRaw(url){
      try{
        const full = CORS_PROXY + encodeURIComponent(url);
        const res = await fetch(full, { cache: 'no-store' , mode:'cors' });
        if(!res.ok) throw new Error('Fetch failed: '+res.status);
        const text = await res.text();
        return { ok:true, text };
      }catch(e){ return { ok:false, error: e.message }; }
    }

    function parseStatusFromText(text, siteId){
      // simple heuristics (case-insensitive)
      const t = text.toLowerCase();
      // patterns indicating closed
      if(/\b(closed today|schools closed|cancelled|canceled|all schools closed|schools are closed)\b/.test(t)) return { status:'CLOSED', reason:'explicit closed phrase' };
      // two-hour delay or "2 hour delay"
      if(/\b(2[ -]?hour delay|two hour delay|2-hour delay|2 hr delay|2hr delay)\b/.test(t)) return { status:'DELAYED', reason:'2 hour delay' };
      if(/\b(1[ -]?hour delay|one hour delay|1-hour delay|1 hr delay|1hr delay)\b/.test(t)) return { status:'DELAYED', reason:'1 hour delay' };
      if(/\b(delay(ed)?|delayed start|late start|opening late|opening 2 hours late|opening 1 hour late)\b/.test(t)) return { status:'DELAYED', reason:'delay phrase' };
      // other synonyms
      if(/\b(remote learning|virtual only|no transportation)\b/.test(t)) return { status:'CLOSED', reason:'remote/no transport' };
      // sometimes sites list "open" explicitly
      if(/\b(open|on time|classes will meet)\b/.test(t)) return { status:'OPEN', reason:'explicit open phrase' };
      // fallback: unknown
      return { status:'UNKNOWN', reason:'no clear keyword' };
    }

    async function doCheck(){
      statusEl.textContent = 'Checking…';
      pill.className = 'pill muted';
      lastCheckedEl.textContent = 'Last checked: '+humanTime();
      const results = [];
      debug.textContent = '';
      for(const t of TARGETS){
        const r = { id:t.id, name:t.name, url:t.url, ok:false, status:'UNKNOWN', reason:'', rawSnippet:'' };
        try{
          const res = await fetchRaw(t.url);
          if(!res.ok){ r.ok=false; r.reason = 'fetch error: '+(res.error||'unknown'); }
          else{
            r.ok = true;
            const sample = res.text.slice(0,4500); // limit debug
            r.rawSnippet = sample.replace(/\s+/g,' ').slice(0,2000);
            const parsed = parseStatusFromText(res.text, t.id);
            r.status = parsed.status;
            r.reason = parsed.reason;
          }
        }catch(e){
          r.ok=false; r.reason = 'exception: '+e.message;
        }
        results.push(r);
      }

      // combine logic
      // Priority: any CLOSED -> CLOSED; else any DELAYED -> DELAYED; else if any UNKNOWN but all ok -> UNKNOWN; else OPEN
      let combined = 'OPEN';
      if(results.some(s=>s.status==='CLOSED')) combined = 'CLOSED';
      else if(results.some(s=>s.status==='DELAYED')) combined = 'DELAYED';
      else if(results.every(s=>s.status==='UNKNOWN')) combined = 'UNKNOWN';
      else combined = 'OPEN';

      // update UI
      statusEl.textContent = combined;
      const now = new Date();
      lastCheckedEl.textContent = 'Last checked: '+humanTime(now);

      pill.textContent = combined;
      pill.className = 'pill ' + (combined==='OPEN' ? 'ok' : combined==='DELAYED' ? 'warn' : combined==='CLOSED' ? 'bad' : 'muted');

      // populate source list
      sourcesList.innerHTML = '';
      let dbgText = '';
      for(const r of results){
        const li = document.createElement('li');
        li.className = 'source';
        const left = document.createElement('div');
        left.innerHTML = `<div class="srcName">${r.name}</div><div class="srcText">${r.ok ? r.status : 'ERROR' }${r.reason ? ' — '+r.reason : ''}</div><div class="time small">URL: ${r.url}</div>`;
        const right = document.createElement('div');
        right.innerHTML = `<div class="time">${r.ok ? 'checked ' + humanTime() : 'failed'}</div>`;
        li.appendChild(left); li.appendChild(right);
        sourcesList.appendChild(li);
        dbgText += `--- ${r.name} (${r.url}) ---\nstatus: ${r.status}\nreason: ${r.reason}\nok: ${r.ok}\nsnippet: ${r.rawSnippet}\n\n`;
      }
      debug.textContent = dbgText;
    }

    // kick off
    doCheck();
    resetTimer();
  </script>
</body>
</html>
